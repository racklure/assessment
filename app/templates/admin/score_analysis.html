
{% extends 'admin/base.html' %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">æœåŠ¡æ˜æ˜Ÿæ±‡æ€»è¡¨</h2>

  <!-- ğŸ”¹ å¹´ + å­£åº¦é€‰æ‹© -->
  <div class="mb-3 row">
    <div class="col-md-2">
      <select id="yearSelect" class="form-select">
        {% for y in range(2023, 2026) %}
        <option value="{{ y }}">{{ y }} å¹´</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <select id="quarterSelect" class="form-select">
        <option value="1">ç¬¬ 1 å­£åº¦</option>
        <option value="2">ç¬¬ 2 å­£åº¦</option>
        <option value="3">ç¬¬ 3 å­£åº¦</option>
        <option value="4">ç¬¬ 4 å­£åº¦</option>
      </select>
    </div>
    <div class="col-md-3">
      <button id="filterBtn" class="btn btn-primary">æŸ¥è¯¢</button>
      <button id="exportBtn" class="btn btn-success ms-2">å¯¼å‡º Excel</button>
    </div>
  </div>

  <!-- ğŸ”¹ æš‚æ— æ•°æ®æç¤º -->
  <div id="noDataMsg" class="alert alert-warning" style="display: none;">
    æš‚æ— è€ƒæ ¸æ•°æ®
  </div>

  <!-- ğŸ”¹ è¡¨æ ¼ -->
  <table class="table table-bordered table-striped" id="summaryTable" style="display: none;">
    <thead class="table-dark">
      <tr id="summaryHeader"></tr>
    </thead>
    <tbody id="summaryBody"></tbody>
  </table>
</div>

<script>
function loadTable(year, quarter) {
  fetch(`/summary/quarter?year=${year}&quarter=${quarter}`)
    .then(response => response.json())
    .then(res => {
      const data = res.data;
      const columns = res.columns || Object.keys(data[0] || {});
      const headerRow = document.getElementById("summaryHeader");
      const body = document.getElementById("summaryBody");
      const table = document.getElementById("summaryTable");
      const noData = document.getElementById("noDataMsg");

      headerRow.innerHTML = '';
      body.innerHTML = '';

      if (!data || data.length === 0) {
        table.style.display = "none";
        noData.style.display = "block";
        return;
      }

      table.style.display = "table";
      noData.style.display = "none";

      // è¡¨å¤´
      columns.forEach(key => {
        const th = document.createElement("th");
        th.textContent = key;
        headerRow.appendChild(th);
      });

      // è¡¨ä½“
      data.forEach(row => {
        const tr = document.createElement("tr");
        columns.forEach(col => {
          const td = document.createElement("td");
          td.textContent = row[col];
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    });
}

document.addEventListener("DOMContentLoaded", () => {
  const yearSel = document.getElementById("yearSelect");
  const quarterSel = document.getElementById("quarterSelect");
  const now = new Date();
  yearSel.value = now.getFullYear();
  quarterSel.value = Math.floor(now.getMonth() / 3) + 1;

  loadTable(yearSel.value, quarterSel.value);

  document.getElementById("filterBtn").addEventListener("click", () => {
    loadTable(yearSel.value, quarterSel.value);
  });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const y = yearSel.value;
    const q = quarterSel.value;
    window.location.href = `/summary/export_excel?year=${y}&quarter=${q}`;
  });
});
</script>
{% endblock %}